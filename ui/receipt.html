<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Receipt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0f17;
      --fg: #e6eefc;
      --muted: #99a3b3;
      --ok: #1db954;
      --warn: #f59e0b;
      --err: #ef4444;
      --card: #121826;
      --chip: #1f2937;
      --link: #60a5fa;
      --border: #22304a;
    }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--fg); }
    .wrap { max-width: 940px; margin: 0 auto; padding: 24px 16px 64px; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 300px; }
    .label { color: var(--muted); font-size: 12px; margin-bottom: 6px; }
    .value { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; word-break: break-all; }
    .chip { display: inline-flex; align-items: center; gap: 8px; background: var(--chip); border-radius: 999px; padding: 6px 10px; font-size: 12px; border: 1px solid var(--border); }
    .chip.ok { background: rgba(29,185,84,0.12); border-color: rgba(29,185,84,0.3); }
    .chip.warn { background: rgba(245,158,11,0.12); border-color: rgba(245,158,11,0.3); }
    .chip.err { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.3); }
    .btnrow { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
    .btn { background: #1f2937; color: var(--fg); border: 1px solid var(--border); padding: 8px 12px; border-radius: 8px; text-decoration: none; font-size: 14px; cursor: pointer; }
    .btn.primary { background: #2563eb; border-color: #1d4ed8; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .small { font-size: 12px; color: var(--muted); }
    .section { margin-top: 18px; }
    .sep { height: 1px; background: var(--border); margin: 16px 0; }
    .code { background: #0f172a; border: 1px solid var(--border); padding: 10px; border-radius: 8px; overflow: auto; font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ISO Middleware Receipt</h1>
    <div id="status-card" class="card section">
      <div class="row">
        <div class="col">
          <div class="label">Receipt ID</div>
          <div id="rid" class="value">-</div>
        </div>
        <div class="col">
          <div class="label">Status</div>
          <div id="status" class="chip">loading…</div>
        </div>
        <div class="col">
          <div class="label">Anchored TX</div>
          <div id="flare_txid" class="value small">-</div>
        </div>
      </div>

      <div class="row section">
        <div class="col">
          <div class="label">Bundle hash</div>
          <div id="bundle_hash" class="value small">-</div>
        </div>
        <div class="col">
          <div class="label">Created at</div>
          <div id="created_at" class="value small">-</div>
        </div>
        <div class="col">
          <div class="label">Anchored at</div>
          <div id="anchored_at" class="value small">-</div>
        </div>
      </div>

      <div class="btnrow">
        <a id="xml_link" class="btn" href="#" target="_blank" rel="noopener">Open XML</a>
        <a id="bundle_link" class="btn" href="#" target="_blank" rel="noopener">Download evidence.zip</a>
        <button id="verify_btn" class="btn primary">Verify Bundle</button>
        <button id="copy_btn" class="btn">Copy receipt link</button>
      </div>

      <div id="verify_out" class="section small"></div>
    </div>

    <div class="section">
      <div class="label">Debug payload</div>
      <pre id="json" class="code">{}</pre>
    </div>
  </div>

  <script>
    (function() {
      const qs = new URLSearchParams(location.search);
      const rid = qs.get('rid');
      const els = {
        rid: document.getElementById('rid'),
        status: document.getElementById('status'),
        flare_txid: document.getElementById('flare_txid'),
        bundle_hash: document.getElementById('bundle_hash'),
        created_at: document.getElementById('created_at'),
        anchored_at: document.getElementById('anchored_at'),
        xml_link: document.getElementById('xml_link'),
        bundle_link: document.getElementById('bundle_link'),
        verify_btn: document.getElementById('verify_btn'),
        copy_btn: document.getElementById('copy_btn'),
        verify_out: document.getElementById('verify_out'),
        json: document.getElementById('json'),
      };

      function setStatusChip(status) {
        els.status.classList.remove('ok','warn','err');
        let text = status;
        if (status === 'anchored') { els.status.classList.add('ok'); text = 'anchored ✓'; }
        else if (status === 'pending') { els.status.classList.add('warn'); text = 'pending…'; }
        else if (status === 'failed') { els.status.classList.add('err'); text = 'failed ✗'; }
        els.status.textContent = text;
      }

      function setLink(el, url, label) {
        if (url) { el.href = url; el.textContent = label; el.removeAttribute('disabled'); }
        else { el.href = '#'; el.textContent = label; el.setAttribute('disabled','true'); }
      }

      function explorerLink(txid) {
        if (!txid) return '-';
        const base = 'https://flare-explorer.flare.network/tx/';
        const a = document.createElement('a');
        a.href = base + txid;
        a.textContent = txid;
        a.target = '_blank';
        a.rel = 'noopener';
        return a.outerHTML;
      }

      function render(rec) {
        els.rid.textContent = rid || '-';
        setStatusChip(rec.status || 'pending');
        els.flare_txid.innerHTML = rec.flare_txid ? explorerLink(rec.flare_txid) : '-';
        els.bundle_hash.textContent = rec.bundle_hash || '-';
        els.created_at.textContent = rec.created_at || '-';
        els.anchored_at.textContent = rec.anchored_at || '-';
        setLink(els.xml_link, rec.xml_url || '#', 'Open XML');
        setLink(els.bundle_link, rec.bundle_url || '#', 'Download evidence.zip');
        els.json.textContent = JSON.stringify(rec, null, 2);
      }

      async function fetchReceipt() {
        const r = await fetch(`/v1/iso/receipts/${rid}`, { cache: 'no-store' });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }

      async function verifyBundle(bundleUrl) {
        const r = await fetch(`/v1/iso/verify`, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ bundle_url: location.origin + bundleUrl }),
        });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      }

      async function init() {
        if (!rid) {
          els.status.textContent = 'missing rid';
          els.status.classList.add('err');
          return;
        }
        try {
          const rec = await fetchReceipt();
          render(rec);
        } catch (e) {
          els.status.textContent = 'error loading receipt';
          els.status.classList.add('err');
        }

        // Wire buttons
        els.verify_btn.addEventListener('click', async () => {
          els.verify_btn.disabled = true;
          els.verify_out.textContent = 'Verifying…';
          try {
            const rec = await fetchReceipt();
            if (!rec.bundle_url) throw new Error('No bundle_url yet');
            const v = await verifyBundle(rec.bundle_url);
            els.verify_out.textContent = `matches_onchain=${v.matches_onchain} | tx=${v.flare_txid || '-'} | errors=${(v.errors||[]).join(',') || '-'}`;
          } catch (e) {
            els.verify_out.textContent = 'Verify failed: ' + (e && e.message || String(e));
          } finally {
            els.verify_btn.disabled = false;
          }
        });

        els.copy_btn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(location.href);
            els.copy_btn.textContent = 'Copied!';
            setTimeout(() => els.copy_btn.textContent = 'Copy receipt link', 1200);
          } catch {}
        });

        // Subscribe SSE
        const es = new EventSource(`/v1/iso/events/${rid}`);
        es.addEventListener('update', (ev) => {
          try {
            const data = JSON.parse(ev.data);
            // Avoid absolute URL duplication
            if (data.xml_url && data.xml_url.startsWith('/')) {} else if (data.xml_url) { data.xml_url = new URL(data.xml_url).pathname; }
            if (data.bundle_url && data.bundle_url.startsWith('/')) {} else if (data.bundle_url) { data.bundle_url = new URL(data.bundle_url).pathname; }
            render(data);
          } catch {}
        });
        es.onerror = () => { /* ignore transient */ };
      }

      init();
    })();
  </script>
</body>
</html>
